apiVersion: v1
kind: Secret
metadata:
  name: vault-init
  namespace: vault
type: Opaque
stringData:
  init-script.sh: |
    #!/bin/sh
    until kubectl get pods -n vault -l app.kubernetes.io/name=vault -o jsonpath='{.items[*].status.conditions[*].status}' | grep -q "True"; do
      sleep 5
    done
    
    # Wait for Vault to be ready (no TLS verification)
    until kubectl exec -n vault vault-0 -- sh -c "VAULT_SKIP_VERIFY=true vault status"; do
      sleep 5
    done
    
    if ! kubectl exec -n vault vault-0 -- sh -c "VAULT_SKIP_VERIFY=true vault status" | grep "Initialized" | grep -q "true"; then
      # Use the configuration from the config map
      INIT_OUTPUT=$(kubectl exec -n vault vault-0 -- sh -c "VAULT_SKIP_VERIFY=true vault operator init \
        -format=json \
        -key-shares=5 \
        -key-threshold=3 \
        -recovery-shares=5 \
        -recovery-threshold=3")
      echo "$INIT_OUTPUT" > /vault/userconfig/vault-init/init-output.json
    fi