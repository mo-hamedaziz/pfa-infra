apiVersion: batch/v1
kind: Job
metadata:
  name: vault-init
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: vault-init
        image: hashicorp/vault:1.15.0
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Waiting for Vault to be ready..."
          until nc -z vault-0.vault-internal 8200; do
            sleep 2
          done

          echo "Initializing Vault..."
          vault operator init -key-shares=1 -key-threshold=1 -format=json > /vault/init/init.json

          echo "Storing keys in Kubernetes..."
          cat /vault/init/init.json | jq -r '.unseal_keys_b64[0]' > /vault/init/unseal-key
          cat /vault/init/init.json | jq -r '.root_token' > /vault/init/root-token

          echo "Unsealing Vault..."
          vault operator unseal $(cat /vault/init/unseal-key)
        volumeMounts:
        - name: init
          mountPath: /vault/init
        - name: vault-tls
          mountPath: /etc/vault/tls
      volumes:
      - name: init
        emptyDir: {}
      - name: vault-tls
        secret:
          secretName: vault-tls